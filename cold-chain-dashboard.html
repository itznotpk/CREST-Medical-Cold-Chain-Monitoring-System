<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Cold Chain Monitoring Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #E1FCC0;
            color: #091F2F;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #091F2F 0%, #2C677B 100%);
            color: #E1FCC0;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo {
            text-align: center;
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(225, 252, 192, 0.2);
            margin-bottom: 20px;
        }

        .logo h2 {
            font-size: 18px;
            font-weight: 600;
            color: #B0FC84;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #E1FCC0;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(95, 166, 132, 0.3);
            border-left-color: #5FA684;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(9, 31, 47, 0.1);
            border-left: 4px solid #5FA684;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: translateY(0);
            user-select: none;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(9, 31, 47, 0.15);
            border-left-width: 6px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fff8 100%);
        }

        .kpi-card:active {
            transform: translateY(-2px) scale(0.98);
            box-shadow: 0 6px 12px rgba(9, 31, 47, 0.12);
            transition: all 0.1s ease;
        }

        .kpi-card:hover .kpi-value {
            color: #5FA684;
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        .kpi-card:hover .kpi-label {
            color: #2C677B;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2C677B;
            transition: all 0.3s ease;
        }

        .kpi-label {
            color: #091F2F;
            font-size: 0.9rem;
            margin-top: 5px;
            transition: all 0.3s ease;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(9, 31, 47, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #B0FC84;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #091F2F;
        }

        /* Bluetooth Toggle */
        .bluetooth-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #2C677B;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #5FA684;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .toggle-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #091F2F;
        }

        /* Cold Box Grid */
        .coldbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .coldbox-item {
            background: white;
            border: 2px solid #B0FC84;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .coldbox-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(9, 31, 47, 0.15);
        }

        .coldbox-item.selected {
            border-color: #5FA684;
            background: linear-gradient(135deg, #B0FC84 0%, #E1FCC0 100%);
        }

        .coldbox-item.temperature-alert {
            border-color: #e53e3e;
            background: linear-gradient(135deg, #fed7d7 0%, #fef2f2 100%);
        }

        .coldbox-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .shipment-id {
            font-size: 1.1rem;
            font-weight: bold;
            color: #091F2F;
        }

        .temperature-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .temp-normal {
            color: #5FA684;
        }

        .temp-alert {
            color: #e53e3e;
        }

        .coldbox-info {
            font-size: 0.9rem;
            color: #2C677B;
            line-height: 1.4;
        }

        .selection-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border: 2px solid #5FA684;
            border-radius: 4px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selection-checkbox.checked {
            background: #5FA684;
            color: white;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #5FA684;
            color: white;
        }

        .btn-primary:hover {
            background: #2C677B;
        }

        .btn-secondary {
            background: #B0FC84;
            color: #091F2F;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pass {
            background: #B0FC84;
            color: #091F2F;
        }

        .status-fail {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-active {
            background: #bee3f8;
            color: #2a4365;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #B0FC84;
        }

        th {
            background: #E1FCC0;
            font-weight: 600;
            color: #091F2F;
        }

        tr:hover {
            background: #E1FCC0;
        }

        /* Bluetooth Scanner */
        .bluetooth-scanner {
            text-align: center;
            padding: 40px;
        }

        .scanner-animation {
            width: 100px;
            height: 100px;
            border: 4px solid #B0FC84;
            border-top: 4px solid #5FA684;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .alert:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(9, 31, 47, 0.15);
            z-index: 10;
        }

        .alert:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }

        .alert.highlight {
            animation: highlightPulse 2s ease-in-out;
            border: 2px solid #5FA684;
            box-shadow: 0 0 20px rgba(95, 166, 132, 0.3);
        }

        @keyframes highlightPulse {
            0%, 100% {
                border-color: #5FA684;
                box-shadow: 0 0 20px rgba(95, 166, 132, 0.3);
            }
            50% {
                border-color: #B0FC84;
                box-shadow: 0 0 30px rgba(95, 166, 132, 0.5);
            }
        }

        .alert-warning {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-danger {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #091F2F;
        }

        select, input {
            padding: 8px 12px;
            border: 1px solid #B0FC84;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(9, 31, 47, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #B0FC84;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #2C677B;
        }

        .close:hover {
            color: #091F2F;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .coldbox-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #2C677B;
        }

        .spinner {
            border: 3px solid #B0FC84;
            border-top: 3px solid #5FA684;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .bluetooth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #E1FCC0;
            border-radius: 8px;
            border-left: 4px solid #5FA684;
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #B0FC84;
            border-top: 3px solid #5FA684;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Scanning Dots Animation */
        .scanning-dots {
            display: flex;
            gap: 4px;
            margin-top: 5px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background-color: #5FA684;
            border-radius: 50%;
            animation: pulse 1.4s ease-in-out infinite both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }

        @keyframes pulse {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Custom Map Popup Styles */
        .custom-popup .leaflet-popup-content-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(9, 31, 47, 0.15);
        }

        .custom-popup .leaflet-popup-content {
            margin: 15px;
            line-height: 1.4;
        }

        .custom-popup .leaflet-popup-tip {
            background: white;
        }

        /* Map container styling */
        #interactive-map {
            border: 2px solid #B0FC84;
            z-index: 1;
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Row highlighting animation */
        @keyframes highlightRow {
            0%, 100% {
                border-color: #5FA684;
                box-shadow: 0 0 20px rgba(95, 166, 132, 0.3);
                background-color: rgba(95, 166, 132, 0.1);
            }
            50% {
                border-color: #B0FC84;
                box-shadow: 0 0 30px rgba(95, 166, 132, 0.5);
                background-color: rgba(95, 166, 132, 0.2);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">
                <h2>Medical Cold Chain</h2>
                <small>Malaysia</small>
            </div>
            
            <div class="nav-item active" onclick="showPage('home')">
                <span class="nav-icon">🏠</span>
                Home
            </div>
            
            <div class="nav-item" onclick="showPage('bluetooth')">
                <span class="nav-icon">🚢</span>
                Penang Dock
            </div>
            
            <div class="nav-item" onclick="showPage('shipments')">
                <span class="nav-icon">📦</span>
                Selected Shipments
            </div>
            
            <div class="nav-item" onclick="showPage('outbound')">
                <span class="nav-icon">🚚</span>
                Outbound Shipments
            </div>
            
            <div class="nav-item" onclick="showPage('reports')">
                <span class="nav-icon">📋</span>
                Reports
            </div>
            
            <div class="nav-item" onclick="showPage('alerts')">
                <span class="nav-icon">🚨</span>
                Alerts & Excursions
            </div>
            
            <div class="nav-item" onclick="showPage('admin')">
                <span class="nav-icon">⚙️</span>
                Admin / Settings
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Home / Overview Page -->
            <div id="home" class="page active">
                <h1 style="margin-bottom: 30px;">OVERVIEW</h1>
                
                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-value">28</div>
                        <div class="kpi-label">Active Cold Boxes</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value">142</div>
                        <div class="kpi-label">Completed This Month</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value">96.8%</div>
                        <div class="kpi-label">PASS Rate</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value">8</div>
                        <div class="kpi-label">Temperature Alerts (30d)</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value">97.2%</div>
                        <div class="kpi-label">Avg Compliance Rate</div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Alerts</h2>
                    </div>
                    <div id="alerts-feed">
                        <div class="alert alert-danger" onclick="navigateToAlert('MY-2025-093')">
                            <span>🚨</span>
                            <div>
                                <strong>Cold Box #MY-2025-093</strong> exceeded 8°C in Kuala Lumpur → Singapore route
                                <div style="font-size: 0.8em; color: #666;">5 minutes ago</div>
                            </div>
                        </div>
                        <div class="alert alert-warning" onclick="navigateToAlert('MY-2025-091')">
                            <span>⚠️</span>
                            <div>
                                <strong>Cold Box #MY-2025-091</strong> approaching upper temperature limit
                                <div style="font-size: 0.8em; color: #666;">22 minutes ago</div>
                            </div>
                        </div>
                        <div class="alert alert-warning" onclick="navigateToAlert('MY-2025-089')">
                            <span>⚠️</span>
                            <div>
                                <strong>Cold Box #MY-2025-089</strong> battery below 25% - Penang facility
                                <div style="font-size: 0.8em; color: #666;">1 hour ago</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interactive Cold Chain Map -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Malaysia & Regional Cold Chain Network</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-secondary" onclick="refreshMapData()">🔄 Refresh</button>
                            <button class="btn btn-secondary" onclick="toggleMapView()">🌐 Satellite</button>
                        </div>
                    </div>
                    <div id="interactive-map" style="height: 400px; border-radius: 8px; position: relative; overflow: hidden;">
                        <!-- Map will be initialized here -->
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #2C677B;">
                        <div>
                            <span style="color: #5FA684;">●</span> Active (18) &nbsp;&nbsp;
                            <span style="color: #ed8936;">●</span> Warning (7) &nbsp;&nbsp;
                            <span style="color: #e53e3e;">●</span> Alert (3)
                        </div>
                        <div>Last updated: <span id="map-last-update">Now</span></div>
                    </div>
                </div>
            </div>

            <!-- Nearby Cold Box (Bluetooth) Page -->
            <div id="bluetooth" class="page">
                <h1 style="margin-bottom: 30px;">PENANG DOCK - INCOMING SHIPMENTS</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Cold Box Arrival Scanner</h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: #5FA684;">
                                <span>📍</span>
                                <strong>Current Location: Penang Medical Center</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scanner Toggle -->
                    <div class="bluetooth-toggle">
                        <span class="toggle-label">Bluetooth</span>
                        <div class="toggle-switch" id="bluetoothToggle" onclick="toggleDockScanner()">
                            <div class="toggle-slider"></div>
                        </div>
                        <span id="bluetoothStatus" class="toggle-label" style="color: #2C677B;">OFF</span>
                    </div>

                    <div id="bluetooth-content">
                        <div class="bluetooth-status" id="statusMessage" style="display: none;">
                            <div class="loading-spinner"></div>
                            <div>
                                <strong id="scanningText">Scanning for incoming cold boxes at Penang dock...</strong>
                                <div class="scanning-dots">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="coldbox-grid" id="coldbox-grid"></div>
                        
                        <!-- Main Action Button -->
                        <div id="main-action-panel" style="display: none; margin-top: 20px; padding: 20px; background: #E1FCC0; border-radius: 8px; text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <span id="selection-count" style="font-size: 1.1rem; font-weight: bold; color: #091F2F;">0 shipments selected</span>
                            </div>
                            <button class="btn btn-primary" id="main-add-btn" onclick="addSelectedToShipments()" style="padding: 12px 30px; font-size: 1rem;" disabled>
                                ➕ Add Selected to Shipments
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selected Shipments Page -->
            <div id="shipments" class="page">
                <h1 style="margin-bottom: 30px;">SELECTED SHIPMENTS</h1>
                
                <!-- Filters -->
                <div class="card">
                    <div class="filters">
                        <div class="filter-group">
                            <label>Status</label>
                            <select onchange="filterShipments()">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="pass">PASS</option>
                                <option value="fail">FAIL</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <input type="date" onchange="filterShipments()">
                        </div>
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" placeholder="Shipment ID or Box ID" oninput="filterShipments()">
                        </div>
                    </div>
                </div>
                
                <!-- Selected Shipments Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Selected Cold Boxes</h2>
                        <span id="selectedCount" style="color: #2C677B;">0 selected</span>
                    </div>
                    <div class="table-container">
                        <table id="selected-shipments-table">
                            <thead>
                                <tr>
                                    <th>Shipment ID</th>
                                    <th>Box ID</th>
                                    <th>Route</th>
                                    <th>Start Time</th>
                                    <th>Current Temp</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="selected-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: #2C677B; padding: 40px;">
                                        No shipments selected. Use "Nearby Cold Box" to detect and select cold boxes.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Outbound Shipments Page -->
            <div id="outbound" class="page">
                <h1 style="margin-bottom: 30px;">OUTBOUND SHIPMENTS FROM PENANG</h1>
                
                <!-- Filters -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Track Outbound Shipments</h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: #5FA684;">
                                <span>📍</span>
                                <strong>Origin: Penang Medical Center</strong>
                            </div>
                        </div>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="statusFilter" onchange="filterByStatus()">
                                <option value="all">All Status</option>
                                <option value="ACTIVE">Active (18)</option>
                                <option value="WARNING">Warning (7)</option>
                                <option value="ALERT">Alert (3)</option>
                                <option value="Delivered">Delivered</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Destination</label>
                            <select onchange="filterOutboundShipments()">
                                <option value="all">All Destinations</option>
                                <option value="peninsular">Peninsular Malaysia</option>
                                <option value="eastmalaysia">East Malaysia</option>
                                <option value="regional">Regional (SG/TH)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <input type="date" onchange="filterOutboundShipments()">
                        </div>
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" placeholder="Shipment ID or Destination" oninput="filterOutboundShipments()">
                        </div>
                    </div>
                </div>
                
                <!-- Outbound Shipments Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Live Tracking - Shipments from Penang</h2>
                        <span style="color: #2C677B;">28 total outbound shipments</span>
                    </div>
                    <div class="table-container">
                        <table id="outbound-shipments-table">
                            <thead>
                                <tr>
                                    <th>Shipment ID</th>
                                    <th>Destination</th>
                                    <th>Medical Device</th>
                                    <th>Departure</th>
                                    <th>Current Temp</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>ETA</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="outbound-tbody">
                                <!-- Active Shipments (18) -->
                                <tr id="outbound-KL-001">
                                    <td>PG-OUT-001</td>
                                    <td>Kuala Lumpur Central Hub</td>
                                    <td>Vaccines</td>
                                    <td>2025-01-15 14:30 MYT</td>
                                    <td><span class="temp-normal">5.2°C</span></td>
                                    <td><span class="status-badge status-active">ACTIVE</span></td>
                                    <td>En route - Ipoh</td>
                                    <td>2025-01-15 18:45 MYT</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showOutboundDetails('PG-OUT-001')">Track</button>
                                    </td>
                                </tr>
                                <tr id="outbound-IP-001">
                                    <td>PG-OUT-002</td>
                                    <td>Ipoh Regional Hub</td>
                                    <td>Antibiotics</td>
                                    <td>2025-01-15 13:15 MYT</td>
                                    <td><span class="temp-normal">3.9°C</span></td>
                                    <td><span class="status-badge status-active">ACTIVE</span></td>
                                    <td>Arrived - Unloading</td>
                                    <td>Delivered</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showOutboundDetails('PG-OUT-002')">Track</button>
                                    </td>
                                </tr>
                                <tr id="outbound-MLK-001">
                                    <td>PG-OUT-003</td>
                                    <td>Melaka Storage Facility</td>
                                    <td>Blood Products</td>
                                    <td>2025-01-15 12:00 MYT</td>
                                    <td><span class="temp-normal">5.7°C</span></td>
                                    <td><span class="status-badge status-active">ACTIVE</span></td>
                                    <td>En route - Muar</td>
                                    <td>2025-01-15 16:20 MYT</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showOutboundDetails('PG-OUT-003')">Track</button>
                                    </td>
                                </tr>
                                <tr id="outbound-KT-001">
                                    <td>PG-OUT-004</td>
                                    <td>Kuantan East Coast Hub</td>
                                    <td>Heart Medication</td>
                                    <td>2025-01-15 15:45 MYT</td>
                                    <td><span class="temp-normal">4.3°C</span></td>
                                    <td><span class="status-badge status-active">ACTIVE</span></td>
                                    <td>En route - Bentong</td>
                                    <td>2025-01-15 22:15 MYT</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showOutboundDetails('PG-OUT-004')">Track</button>
                                    </td>
                                </tr>
                                <tr id="outbound-KCH-001">
                                    <td>PG-OUT-005</td>
                                    <td>Kuching Medical Hub</td>
                                    <td>Vaccines</td>
                                    <td>2025-01-15 11:30 MYT</td>
                                    <td><span class="temp-normal">6.1°C</span></td>
                                    <td><span class="status-badge status-active">ACTIVE</span></td>
                                    <td>In transit - Flight MH2574</td>
                                    <td>2025-01-15 17:50 MYT</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showOutboundDetails('PG-OUT-005')">Track</button>
                                    </td>
                                </tr>
                                <tr id="outbound-SDK-001">
                                    <td>PG-OUT-006</td>
                                    <td>Sandakan Facility</td>
                                    <td>Insulin Pens</td>
                                    <td>2025-01-15 10:15 MYT</td>
                                    <td><span class="temp-normal">4.7°C</span></td>
                                    <td><span class="status-badge status-active">ACTIVE</span></td>
                                    <td>In transit - Flight MH2590</td>
                                    <td>2025-01-15 19:30 MYT</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showOutboundDetails('PG-OUT-006')">Track</button>
                                    </td>
                                </tr>
                                <tr id="outbound-SG-001">
                                    <td>PG-OUT-007</td>
                                    <td>Singapore Medical Port</td>
                                    <td>Blood Products</td>
                                    <td>2025-01-15 16:20 MYT</td>
                                    <td><span class="temp-normal">5.4°C</span></td>
                                    <td><span class="status-badge status-active">ACTIVE</span></td>
                                    <td>En route - Kulai</td>
                                    <td>2025-01-15 22:45 MYT</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showOutboundDetails('PG-OUT-007')">Track</button>
                                    </td>
                                </tr>
                                <tr id="outbound-BKK-001">
                                    <td>PG-OUT-008</td>
                                    <td>Bangkok Distribution</td>
                                    <td>Vaccines</td>
                                    <td>2025-01-15 09:45 MYT</td>
                                    <td><span class="temp-normal">6.0°C</span></td>
                                    <td><span class="status-badge status-active">ACTIVE</span></td>
                                    <td>Border checkpoint - Padang Besar</td>
                                    <td>2025-01-16 06:30 MYT</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showOutboundDetails('PG-OUT-008')">Track</button>
                                    </td>
                                </tr>
                                
                                <!-- Warning Shipments (7) -->
                                <tr id="outbound-JB-001" style="background: #fffbeb;">
                                    <td>PG-OUT-009</td>
                                    <td>Johor Bahru Distribution</td>
                                    <td>Insulin Pens</td>
                                    <td>2025-01-15 14:00 MYT</td>
                                    <td><span class="temp-warning" style="color: #ed8936;">7.6°C</span></td>
                                    <td><span class="status-badge" style="background: #ed8936; color: white;">WARNING</span></td>
                                    <td>En route - Seremban</td>
                                    <td>2025-01-16 08:30 MYT</td>
                                    <td>
                                        <button class="btn btn-warning" onclick="showOutboundDetails('PG-OUT-009')">Monitor</button>
                                    </td>
                                </tr>
                                <tr id="outbound-MRI-001" style="background: #fffbeb;">
                                    <td>PG-OUT-010</td>
                                    <td>Miri Northern Hub</td>
                                    <td>Heart Medication</td>
                                    <td>2025-01-15 11:20 MYT</td>
                                    <td><span class="temp-warning" style="color: #ed8936;">7.8°C</span></td>
                                    <td><span class="status-badge" style="background: #ed8936; color: white;">WARNING</span></td>
                                    <td>In transit - Flight MH2586</td>
                                    <td>2025-01-15 18:15 MYT</td>
                                    <td>
                                        <button class="btn btn-warning" onclick="showOutboundDetails('PG-OUT-010')">Monitor</button>
                                    </td>
                                </tr>
                                <tr id="outbound-HDY-001" style="background: #fffbeb;">
                                    <td>PG-OUT-011</td>
                                    <td>Hat Yai Border Hub</td>
                                    <td>Antibiotics</td>
                                    <td>2025-01-15 12:30 MYT</td>
                                    <td><span class="temp-warning" style="color: #ed8936;">7.9°C</span></td>
                                    <td><span class="status-badge" style="background: #ed8936; color: white;">WARNING</span></td>
                                    <td>Customs clearance - Bukit Kayu Hitam</td>
                                    <td>2025-01-15 20:45 MYT</td>
                                    <td>
                                        <button class="btn btn-warning" onclick="showOutboundDetails('PG-OUT-011')">Monitor</button>
                                    </td>
                                </tr>
                                
                                <!-- Alert Shipments (3) -->
                                <tr id="outbound-KK-001" style="background: #fef2f2;">
                                    <td>PG-OUT-012</td>
                                    <td>Kota Kinabalu Center</td>
                                    <td>Insulin Pens</td>
                                    <td>2025-01-15 08:00 MYT</td>
                                    <td><span class="temp-alert">9.2°C</span></td>
                                    <td><span class="status-badge" style="background: #e53e3e; color: white;">ALERT</span></td>
                                    <td>In transit - Flight MH2592 - DELAYED</td>
                                    <td>Delayed</td>
                                    <td>
                                        <button class="btn btn-danger" onclick="showOutboundDetails('PG-OUT-012')">URGENT</button>
                                    </td>
                                </tr>
                                <tr id="outbound-PKT-001" style="background: #fef2f2;">
                                    <td>PG-OUT-013</td>
                                    <td>Phuket Medical Center</td>
                                    <td>Heart Medication</td>
                                    <td>2025-01-15 13:45 MYT</td>
                                    <td><span class="temp-alert">8.9°C</span></td>
                                    <td><span class="status-badge" style="background: #e53e3e; color: white;">ALERT</span></td>
                                    <td>Stopped - Surat Thani checkpoint</td>
                                    <td>Delayed</td>
                                    <td>
                                        <button class="btn btn-danger" onclick="showOutboundDetails('PG-OUT-013')">URGENT</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports" class="page">
                <h1 style="margin-bottom: 30px;">REPORTS</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Generate New Report</h2>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Report Type</label>
                            <select>
                                <option>Medical Device Compliance</option>
                                <option>Temperature Excursion Analysis</option>
                                <option>Cold Box Performance</option>
                                <option>Malaysia Route Analysis</option>
                                <option>Pharmaceutical Transport Summary</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <input type="date">
                        </div>
                        <div class="filter-group">
                            <label>Format</label>
                            <select>
                                <option>PDF</option>
                                <option>CSV</option>
                                <option>Excel</option>
                            </select>
                        </div>
                        <button class="btn btn-primary">Generate Report</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Reports</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Report Name</th>
                                    <th>Type</th>
                                    <th>Generated</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Medical Device Transport - Jan 2025</td>
                                    <td>Compliance Summary</td>
                                    <td>2025-01-15 09:30 MYT</td>
                                    <td><span class="status-badge status-pass">COMPLETE</span></td>
                                    <td>
                                        <button class="btn btn-secondary">Download</button>
                                        <button class="btn btn-secondary">Share</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>KL-Singapore Route Analysis</td>
                                    <td>Route Performance</td>
                                    <td>2025-01-14 16:20 MYT</td>
                                    <td><span class="status-badge status-pass">COMPLETE</span></td>
                                    <td>
                                        <button class="btn btn-secondary">Download</button>
                                        <button class="btn btn-secondary">Share</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Alerts Page -->
            <div id="alerts" class="page">
                <h1 style="margin-bottom: 30px;">ALERTS & EXCURSIONS</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Live Alert Feed</h2>
                        <div>
                            <button class="btn btn-secondary">Mark All Read</button>
                            <button class="btn btn-primary">Configure Alerts</button>
                        </div>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label>Severity</label>
                            <select>
                                <option>All</option>
                                <option>Critical</option>
                                <option>Warning</option>
                                <option>Info</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select>
                                <option>All</option>
                                <option>Active</option>
                                <option>Acknowledged</option>
                                <option>Resolved</option>
                            </select>
                        </div>
                    </div>

                    <div style="max-height: 500px; overflow-y: auto;">
                        <div class="alert alert-danger" id="alert-MY-2025-093">
                            <span>🚨</span>
                            <div style="flex: 1;">
                                <strong>Critical: MY-2025-093 Temperature Excursion</strong><br>
                                Temperature reached 11.2°C during KL → Singapore transport. Duration: 1h 45min<br>
                                <small style="color: #666;">Location: North-South Highway | Medical Device: Insulin Pens</small>
                            </div>
                            <div>
                                <button class="btn btn-secondary">Acknowledge</button>
                                <button class="btn btn-primary">View Details</button>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning" id="alert-MY-2025-091">
                            <span>⚠️</span>
                            <div style="flex: 1;">
                                <strong>Warning: MY-2025-091 Approaching Limit</strong><br>
                                Current temperature: 7.6°C (approaching 8°C limit)<br>
                                <small style="color: #666;">Location: Penang → Ipoh | Medical Device: Vaccines</small>
                            </div>
                            <div>
                                <button class="btn btn-secondary">Acknowledge</button>
                                <button class="btn btn-primary">Monitor</button>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning" id="alert-MY-2025-089">
                            <span>⚠️</span>
                            <div style="flex: 1;">
                                <strong>Warning: MY-2025-089 Low Battery</strong><br>
                                Battery level at 23%. Estimated time remaining: 8 hours<br>
                                <small style="color: #666;">Last location: Johor Bahru Facility | Medical Device: Blood Products</small>
                            </div>
                            <div>
                                <button class="btn btn-secondary">Acknowledge</button>
                                <button class="btn btn-primary">Schedule Maintenance</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Page -->
            <div id="admin" class="page">
                <h1 style="margin-bottom: 30px;">SETTINGS</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Medical Device Temperature Thresholds</h2>
                    </div>
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Standard Medical Devices (2-8°C)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="number" value="2" style="width: 80px;"> °C to
                                <input type="number" value="8" style="width: 80px;"> °C
                                <button class="btn btn-secondary">Update</button>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Frozen Medical Products (-20°C)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="number" value="-25" style="width: 80px;"> °C to
                                <input type="number" value="-15" style="width: 80px;"> °C
                                <button class="btn btn-secondary">Update</button>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Room Temperature Stable (15-25°C)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="number" value="15" style="width: 80px;"> °C to
                                <input type="number" value="25" style="width: 80px;"> °C
                                <button class="btn btn-secondary">Update</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">User Management</h2>
                        <button class="btn btn-primary">Add User</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Ahmad Rahman</td>
                                    <td>ahmad.rahman@medicorp.my</td>
                                    <td>Administrator</td>
                                    <td>2025-01-15 09:30 MYT</td>
                                    <td><button class="btn btn-secondary">Edit</button></td>
                                </tr>
                                <tr>
                                    <td>Siti Nurhaliza</td>
                                    <td>siti.nurhaliza@medicorp.my</td>
                                    <td>QA Officer</td>
                                    <td>2025-01-15 08:45 MYT</td>
                                    <td><button class="btn btn-secondary">Edit</button></td>
                                </tr>
                                <tr>
                                    <td>Lim Wei Ming</td>
                                    <td>lim.weiming@medicorp.my</td>
                                    <td>Cold Chain Supervisor</td>
                                    <td>2025-01-15 07:20 MYT</td>
                                    <td><button class="btn btn-secondary">Edit</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">System Integrations</h2>
                    </div>
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #E1FCC0; border-radius: 8px;">
                            <div>
                                <strong>Malaysia Healthcare ERP</strong><br>
                                <small style="color: #2C677B;">Integration with Ministry of Health systems</small>
                            </div>
                            <div>
                                <span class="status-badge status-pass">Connected</span>
                                <button class="btn btn-secondary">Configure</button>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #E1FCC0; border-radius: 8px;">
                            <div>
                                <strong>SMS Alerts (Malaysia)</strong><br>
                                <small style="color: #2C677B;">Local SMS gateway for emergency notifications</small>
                            </div>
                            <div>
                                <span class="status-badge status-pass">Active</span>
                                <button class="btn btn-secondary">Configure</button>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #E1FCC0; border-radius: 8px;">
                            <div>
                                <strong>API Access</strong><br>
                                <small style="color: #2C677B;">REST API for hospital integrations</small>
                            </div>
                            <div>
                                <span class="status-badge status-pass">Enabled</span>
                                <button class="btn btn-secondary">Manage Keys</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shipment Details Modal -->
    <div id="shipmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Cold Box Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Sample data for Malaysian medical cold chain - INCOMING TO PENANG
        const coldBoxData = {
            'MY-2025-093': {
                id: 'MY-2025-093',
                boxId: 'MCB-4421',
                route: 'Kuala Lumpur → Penang',
                origin: 'Kuala Lumpur Central Hub',
                startTime: '2025-01-15 08:00 MYT',
                arrivalTime: '2025-01-15 14:30 MYT',
                currentTemp: 6.2,
                status: 'PASS',
                medicalDevice: 'Insulin Pens',
                minTemp: 2.1,
                maxTemp: 7.8,
                avgTemp: 5.4,
                timeInRange: 98.2,
                timeOutRange: 1.8,
                excursions: 0,
                loggerBattery: 78,
                dockBay: 'A3',
                calibrationDate: 'Mar 2025',
                temperatureData: [
                    {time: '08:00', temp: 4.2},
                    {time: '09:00', temp: 5.8},
                    {time: '10:00', temp: 6.9},
                    {time: '11:00', temp: 6.2},
                    {time: '12:00', temp: 5.8},
                    {time: '13:00', temp: 6.1},
                    {time: '14:30', temp: 6.2}
                ]
            },
            'MY-2025-094': {
                id: 'MY-2025-094',
                boxId: 'MCB-4422',
                route: 'Ipoh → Penang',
                origin: 'Ipoh Regional Hub',
                startTime: '2025-01-15 10:15 MYT',
                arrivalTime: '2025-01-15 12:45 MYT',
                currentTemp: 5.2,
                status: 'PASS',
                medicalDevice: 'Vaccines',
                minTemp: 3.1,
                maxTemp: 7.2,
                avgTemp: 5.1,
                timeInRange: 100,
                timeOutRange: 0,
                excursions: 0,
                loggerBattery: 92,
                dockBay: 'B1',
                temperatureData: [
                    {time: '10:15', temp: 4.1},
                    {time: '11:00', temp: 5.8},
                    {time: '12:00', temp: 6.2},
                    {time: '12:45', temp: 5.2}
                ]
            },
            'MY-2025-095': {
                id: 'MY-2025-095',
                boxId: 'MCB-4423',
                route: 'Johor Bahru → Penang',
                origin: 'Johor Bahru Distribution',
                startTime: '2025-01-15 06:30 MYT',
                arrivalTime: '2025-01-15 15:20 MYT',
                currentTemp: 4.8,
                status: 'PASS',
                medicalDevice: 'Blood Products',
                loggerBattery: 85,
                dockBay: 'A1',
                temperatureData: [
                    {time: '06:30', temp: 4.8},
                    {time: '08:00', temp: 5.2},
                    {time: '10:00', temp: 5.8},
                    {time: '12:00', temp: 6.1},
                    {time: '14:00', temp: 5.4},
                    {time: '15:20', temp: 4.8}
                ]
            },
            'MY-2025-096': {
                id: 'MY-2025-096',
                boxId: 'MCB-4424',
                route: 'Kuching → Penang',
                origin: 'Kuching Medical Hub',
                startTime: '2025-01-15 05:00 MYT',
                arrivalTime: '2025-01-15 16:15 MYT',
                currentTemp: 4.3,
                status: 'PASS',
                medicalDevice: 'Antibiotics',
                loggerBattery: 67,
                dockBay: 'C2',
                temperatureData: [
                    {time: '05:00', temp: 3.8},
                    {time: '08:00', temp: 4.5},
                    {time: '12:00', temp: 5.1},
                    {time: '16:15', temp: 4.3}
                ]
            },
            'MY-2025-097': {
                id: 'MY-2025-097',
                boxId: 'MCB-4425',
                route: 'Singapore → Penang',
                origin: 'Singapore Medical Port',
                startTime: '2025-01-15 07:45 MYT',
                arrivalTime: '2025-01-15 17:30 MYT',
                currentTemp: 9.2,
                status: 'FAIL',
                medicalDevice: 'Heart Medication',
                loggerBattery: 45,
                dockBay: 'B3',
                temperatureData: [
                    {time: '07:45', temp: 5.2},
                    {time: '10:30', temp: 6.8},
                    {time: '14:15', temp: 8.9},
                    {time: '17:30', temp: 9.2}
                ]
            }
        };

        let selectedColdBoxes = new Set();
        let bluetoothEnabled = false;
        let interactiveMap = null;
        let currentMapView = 'streets'; // 'streets' or 'satellite'
        let tempSelectedBoxes = new Set(); // For dock multi-select
        
        // Malaysian Cold Chain Locations Data
        const coldChainLocations = [
            // Malaysia - Peninsular
            { id: 'KL-001', name: 'Kuala Lumpur Central Hub', lat: 3.1390, lng: 101.6869, status: 'active', count: 4, temp: 5.2 },
            { id: 'PG-001', name: 'Penang Medical Center', lat: 5.4164, lng: 100.3327, status: 'active', count: 2, temp: 4.8 },
            { id: 'JB-001', name: 'Johor Bahru Distribution', lat: 1.4927, lng: 103.7414, status: 'warning', count: 3, temp: 7.6 },
            { id: 'IP-001', name: 'Ipoh Regional Hub', lat: 4.5975, lng: 101.0901, status: 'active', count: 1, temp: 3.9 },
            { id: 'MLK-001', name: 'Melaka Storage Facility', lat: 2.1896, lng: 102.2501, status: 'active', count: 2, temp: 5.7 },
            { id: 'KT-001', name: 'Kuantan East Coast Hub', lat: 3.8077, lng: 103.3260, status: 'active', count: 1, temp: 4.3 },
            
            // Malaysia - East Malaysia
            { id: 'KCH-001', name: 'Kuching Medical Hub', lat: 1.5533, lng: 110.3592, status: 'active', count: 3, temp: 6.1 },
            { id: 'KK-001', name: 'Kota Kinabalu Center', lat: 5.9804, lng: 116.0735, status: 'alert', count: 2, temp: 9.2 },
            { id: 'MRI-001', name: 'Miri Northern Hub', lat: 4.3946, lng: 113.9932, status: 'warning', count: 1, temp: 7.8 },
            { id: 'SDK-001', name: 'Sandakan Facility', lat: 5.8402, lng: 118.1179, status: 'active', count: 1, temp: 4.7 },
            
            // Regional - Singapore & Thailand
            { id: 'SG-001', name: 'Singapore Medical Port', lat: 1.3521, lng: 103.8198, status: 'active', count: 3, temp: 5.4 },
            { id: 'BKK-001', name: 'Bangkok Distribution', lat: 13.7563, lng: 100.5018, status: 'active', count: 2, temp: 6.0 },
            { id: 'HDY-001', name: 'Hat Yai Border Hub', lat: 7.0103, lng: 100.4670, status: 'warning', count: 2, temp: 7.9 },
            { id: 'PKT-001', name: 'Phuket Medical Center', lat: 7.8804, lng: 98.3923, status: 'alert', count: 1, temp: 8.9 }
        ];

        // Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active to selected nav item
            event.target.classList.add('active');
            
            // Update selected shipments table when switching to shipments page
            if (pageId === 'shipments') {
                updateSelectedShipmentsTable();
            }
        }

        // Navigate to specific alert
        function navigateToAlert(alertId) {
            // Switch to alerts page
            showPageDirectly('alerts');
            
            // Highlight the specific alert
            setTimeout(() => {
                const targetAlert = document.getElementById(`alert-${alertId}`);
                if (targetAlert) {
                    // Remove any existing highlights
                    document.querySelectorAll('.alert').forEach(alert => {
                        alert.classList.remove('highlight');
                    });
                    
                    // Add highlight to target alert
                    targetAlert.classList.add('highlight');
                    
                    // Scroll to the alert
                    targetAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Remove highlight after animation
                    setTimeout(() => {
                        targetAlert.classList.remove('highlight');
                    }, 2000);
                }
            }, 100);
        }

        // Helper function to show page directly (without event context)
        function showPageDirectly(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active to corresponding nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.onclick && item.onclick.toString().includes(pageId)) {
                    item.classList.add('active');
                }
            });
        }

        // Dock Scanner Toggle
        function toggleDockScanner() {
            const toggle = document.getElementById('bluetoothToggle');
            const status = document.getElementById('bluetoothStatus');
            const statusMessage = document.getElementById('statusMessage');
            const coldboxGrid = document.getElementById('coldbox-grid');
            const scanningText = document.getElementById('scanningText');
            
            bluetoothEnabled = !bluetoothEnabled;
            
            if (bluetoothEnabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
                status.style.color = '#5FA684';
                statusMessage.style.display = 'flex';
                coldboxGrid.innerHTML = '';
                
                // Phase 1: Initializing dock scanner
                scanningText.innerHTML = 'Initializing dock scanner system...';
                
                // Phase 2: Scanning dock
                setTimeout(() => {
                    scanningText.innerHTML = 'Scanning Penang dock for arrived cold boxes...';
                }, 800);
                
                // Phase 3: Found shipments
                setTimeout(() => {
                    scanningText.innerHTML = 'Found 5 arrived shipments at dock!';
                }, 2500);
                
                // Phase 4: Show results
                setTimeout(() => {
                    statusMessage.innerHTML = `
                        <span style="color: #5FA684; font-size: 20px;">🚢</span>
                        <div>
                            <strong>Dock Scan Complete!</strong><br>
                            <small style="color: #2C677B;">5 cold boxes arrived and ready for processing</small>
                        </div>
                    `;
                    displayArrivedColdBoxes();
                }, 3000);
                
            } else {
                toggle.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#2C677B';
                statusMessage.style.display = 'none';
                coldboxGrid.innerHTML = '';
            }
        }

        // Display Arrived Cold Boxes at Penang Dock
        function displayArrivedColdBoxes() {
            const grid = document.getElementById('coldbox-grid');
            grid.innerHTML = '';
            
            Object.values(coldBoxData).forEach(box => {
                const isAlert = box.status === 'FAIL';
                const isInQueue = selectedColdBoxes.has(box.id);
                const isSelected = tempSelectedBoxes.has(box.id);
                
                const boxElement = document.createElement('div');
                boxElement.className = `coldbox-item ${isAlert ? 'temperature-alert' : ''} ${isSelected ? 'selected' : ''} ${isInQueue ? 'already-queued' : ''}`;
                boxElement.onclick = () => toggleBoxSelection(box.id);
                
                boxElement.innerHTML = `
                    <div class="selection-checkbox ${isSelected ? 'checked' : ''} ${isInQueue ? 'disabled' : ''}" style="position: absolute; top: 10px; left: 10px; ${isInQueue ? 'background: #ccc; border-color: #999;' : ''}">
                        ${isInQueue ? '✓' : isSelected ? '✓' : ''}
                    </div>
                    <div class="coldbox-header">
                        <div class="shipment-id">${box.id}</div>
                        <div class="temperature-display ${isAlert ? 'temp-alert' : 'temp-normal'}">
                            🌡️ ${box.currentTemp}°C
                        </div>
                    </div>
                    <div class="coldbox-info">
                        <strong>From:</strong> ${box.origin}<br>
                        <strong>Route:</strong> ${box.route}<br>
                        <strong>Medical Device:</strong> ${box.medicalDevice}<br>
                        <strong>Arrived:</strong> ${box.arrivalTime}<br>
                        <strong>Status:</strong> <span class="status-badge ${box.status === 'PASS' ? 'status-pass' : 'status-fail'}">${box.status}</span><br>
                        <strong>Logger Battery:</strong> ${box.loggerBattery}%
                    </div>
                `;
                
                grid.appendChild(boxElement);
            });
            
            updateSelectionUI();
        }

        // Toggle individual box selection for dock
        function toggleBoxSelection(boxId) {
            if (selectedColdBoxes.has(boxId)) {
                // Already in processing queue, do nothing
                return;
            }
            
            if (tempSelectedBoxes.has(boxId)) {
                tempSelectedBoxes.delete(boxId);
            } else {
                tempSelectedBoxes.add(boxId);
            }
            
            displayArrivedColdBoxes();
        }

        // Update selection UI
        function updateSelectionUI() {
            const panel = document.getElementById('main-action-panel');
            const countSpan = document.getElementById('selection-count');
            const addBtn = document.getElementById('main-add-btn');
            
            const selectedCount = tempSelectedBoxes.size;
            
            if (selectedCount > 0) {
                panel.style.display = 'block';
                countSpan.textContent = `${selectedCount} shipment${selectedCount > 1 ? 's' : ''} selected`;
                addBtn.disabled = false;
            } else {
                panel.style.display = 'none';
                addBtn.disabled = true;
            }
        }

        // Add selected shipments to processing queue
        function addSelectedToShipments() {
            if (tempSelectedBoxes.size === 0) return;
            
            const selectedBoxesList = Array.from(tempSelectedBoxes).map(boxId => {
                const box = coldBoxData[boxId];
                return `${box.id} (${box.medicalDevice})`;
            }).join('\n');
            
            const confirmDialog = confirm(
                `CONFIRM BATCH ADDITION\n\n` +
                `Add ${tempSelectedBoxes.size} shipments to processing queue?\n\n` +
                `Selected shipments:\n${selectedBoxesList}\n\n` +
                `These will be moved to "Selected Shipments" for detailed processing.`
            );
            
            if (confirmDialog) {
                // Add all selected to the main queue
                tempSelectedBoxes.forEach(boxId => {
                    selectedColdBoxes.add(boxId);
                });
                
                // Clear temporary selection
                tempSelectedBoxes.clear();
                
                // Refresh display
                displayArrivedColdBoxes();
                updateSelectedShipmentsTable();
                
                // Show success notification
                showNotification(`✅ ${selectedColdBoxes.size} shipments added to processing queue!`, 'success');
            }
        }

        // Confirm Add to Shipments (legacy function - now redirects to multi-select)
        function confirmAddToShipments(boxId) {
            toggleBoxSelection(boxId);
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#5FA684' : '#2C677B'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 3000;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(9, 31, 47, 0.2);
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Toggle Cold Box Selection (legacy function for compatibility)
        function toggleColdBoxSelection(boxId) {
            // For dock interface, we use confirmation instead of direct toggle
            confirmAddToShipments(boxId);
        }

        // Update Selected Shipments Table
        function updateSelectedShipmentsTable() {
            const tbody = document.getElementById('selected-tbody');
            const countElement = document.getElementById('selectedCount');
            
            countElement.textContent = `${selectedColdBoxes.size} selected`;
            
            if (selectedColdBoxes.size === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #2C677B; padding: 40px;">
                            No shipments selected. Use "Nearby Cold Box" to detect and select cold boxes.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            selectedColdBoxes.forEach(boxId => {
                const box = coldBoxData[boxId];
                if (!box) return;
                
                const isAlert = box.currentTemp > 8 || box.currentTemp < 2;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${box.id}</td>
                    <td>${box.boxId}</td>
                    <td>${box.route}</td>
                    <td>${box.startTime}</td>
                    <td><span class="${isAlert ? 'temp-alert' : 'temp-normal'}">${box.currentTemp}°C</span></td>
                    <td><span class="status-badge status-${box.status.toLowerCase()}">${box.status}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="showColdBoxDetails('${box.id}')">View</button>
                        <button class="btn btn-secondary" onclick="removeColdBox('${box.id}')" style="margin-left: 5px;">Remove</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Remove Cold Box from Selection
        function removeColdBox(boxId) {
            selectedColdBoxes.delete(boxId);
            updateSelectedShipmentsTable();
            if (bluetoothEnabled) {
                displayArrivedColdBoxes();
            }
        }

        // Show Cold Box Details Modal
        function showColdBoxDetails(boxId) {
            const box = coldBoxData[boxId];
            if (!box) return;
            
            const modal = document.getElementById('shipmentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = `${box.id} - ${box.medicalDevice} Details`;
            
            const isAlert = box.currentTemp > 8 || box.currentTemp < 2;
            
            modalContent.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <!-- Header Info -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #E1FCC0; border-radius: 8px;">
                        <div><strong>Route:</strong> ${box.route}</div>
                        <div><strong>Start:</strong> ${box.startTime}</div>
                        <div><strong>Medical Device:</strong> ${box.medicalDevice}</div>
                        <div><strong>Current Temp:</strong> <span class="${isAlert ? 'temp-alert' : 'temp-normal'}">${box.currentTemp}°C</span></div>
                        <div><strong>Status:</strong> <span class="status-badge status-${box.status.toLowerCase()}">${box.status}</span></div>
                        <div><strong>Battery:</strong> ${box.loggerBattery}%</div>
                    </div>
                    
                    <!-- Temperature Chart -->
                    <div>
                        <h3 style="margin-bottom: 15px;">Temperature Timeline</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Summary Metrics (if completed) -->
                    ${box.status !== 'ACTIVE' ? `
                    <div>
                        <h3 style="margin-bottom: 15px;">Summary Metrics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div class="kpi-card">
                                <div class="kpi-value">${box.minTemp}°C</div>
                                <div class="kpi-label">Min Temperature</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${box.maxTemp}°C</div>
                                <div class="kpi-label">Max Temperature</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${box.avgTemp}°C</div>
                                <div class="kpi-label">Avg Temperature</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${box.timeInRange}%</div>
                                <div class="kpi-label">Time in Range</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${box.excursions}</div>
                                <div class="kpi-label">Excursions</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-value">${box.degreeHours}</div>
                                <div class="kpi-label">Degree Hours >8°C</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Export Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="exportPDF('${box.id}')">📄 Export PDF</button>
                        <button class="btn btn-secondary" onclick="exportCSV('${box.id}')">📊 Export CSV</button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Initialize temperature chart
            setTimeout(() => initTempChart(box), 100);
        }

        function closeModal() {
            document.getElementById('shipmentModal').style.display = 'none';
        }

        // Chart Initialization
        function initTempChart(box) {
            const ctx = document.getElementById('tempChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: box.temperatureData.map(d => d.time),
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: box.temperatureData.map(d => d.temp),
                        borderColor: '#5FA684',
                        backgroundColor: 'rgba(95, 166, 132, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Upper Limit (8°C)',
                        data: box.temperatureData.map(() => 8),
                        borderColor: '#e53e3e',
                        borderDash: [5, 5],
                        backgroundColor: 'transparent',
                        pointRadius: 0
                    }, {
                        label: 'Lower Limit (2°C)',
                        data: box.temperatureData.map(() => 2),
                        borderColor: '#2C677B',
                        borderDash: [5, 5],
                        backgroundColor: 'transparent',
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (MYT)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // Filter functions
        function filterShipments() {
            console.log('Filtering selected shipments...');
        }

        function filterByStatus() {
            const filterValue = document.getElementById('statusFilter').value;
            const tableBody = document.getElementById('outbound-tbody');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const statusCell = row.querySelector('.status-badge');
                if (!statusCell) return;
                
                const status = statusCell.textContent.trim();
                
                if (filterValue === 'all' || status === filterValue) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function filterOutboundShipments() {
            console.log('Filtering outbound shipments...');
        }

        function showOutboundDetails(shipmentId) {
            // Outbound shipment data aligned with map locations
            const outboundData = {
                'PG-OUT-001': {
                    id: 'PG-OUT-001',
                    destination: 'Kuala Lumpur Central Hub',
                    medicalDevice: 'Vaccines',
                    departure: '2025-01-15 14:30 MYT',
                    currentTemp: 5.2,
                    status: 'ACTIVE',
                    currentLocation: 'En route - Ipoh',
                    eta: '2025-01-15 18:45 MYT',
                    driver: 'Ahmad bin Hassan',
                    vehicle: 'Cold Chain Truck PG-CC-001',
                    route: 'Penang → Ipoh → KL',
                    distance: '365 km',
                    progress: '45%'
                },
                'PG-OUT-009': {
                    id: 'PG-OUT-009',
                    destination: 'Johor Bahru Distribution',
                    medicalDevice: 'Insulin Pens',
                    departure: '2025-01-15 14:00 MYT',
                    currentTemp: 7.6,
                    status: 'WARNING',
                    currentLocation: 'En route - Seremban',
                    eta: '2025-01-16 08:30 MYT',
                    driver: 'Rajesh Kumar',
                    vehicle: 'Cold Chain Truck PG-CC-009',
                    route: 'Penang → Kuala Lumpur → Seremban → JB',
                    distance: '785 km',
                    progress: '25%',
                    issue: 'Temperature approaching upper limit - monitoring required'
                },
                'PG-OUT-012': {
                    id: 'PG-OUT-012',
                    destination: 'Kota Kinabalu Center',
                    medicalDevice: 'Insulin Pens',
                    departure: '2025-01-15 08:00 MYT',
                    currentTemp: 9.2,
                    status: 'ALERT',
                    currentLocation: 'In transit - Flight MH2592 - DELAYED',
                    eta: 'Delayed',
                    driver: 'Flight Cargo Handler',
                    vehicle: 'Cargo Flight MH2592',
                    route: 'Penang → Kota Kinabalu (Air)',
                    distance: '1,420 km',
                    progress: '60%',
                    issue: 'Critical temperature excursion - cargo hold cooling malfunction'
                },
                'PG-OUT-013': {
                    id: 'PG-OUT-013',
                    destination: 'Phuket Medical Center',
                    medicalDevice: 'Heart Medication',
                    departure: '2025-01-15 13:45 MYT',
                    currentTemp: 8.9,
                    status: 'ALERT',
                    currentLocation: 'Stopped - Surat Thani checkpoint',
                    eta: 'Delayed',
                    driver: 'Somchai Thanakit',
                    vehicle: 'International Cold Chain Truck TH-CC-105',
                    route: 'Penang → Hat Yai → Surat Thani → Phuket',
                    distance: '580 km',
                    progress: '70%',
                    issue: 'Customs delay + cooling system stress from prolonged stop'
                }
            };

            // Get location data for context
            const locationId = getLocationIdByShipmentId(shipmentId);
            const locationData = coldChainLocations.find(loc => loc.id === locationId);

            const shipment = outboundData[shipmentId] || {
                id: shipmentId,
                destination: 'Loading details...',
                medicalDevice: 'Loading...',
                status: 'TRACKING',
                message: 'Detailed tracking information will be available shortly.'
            };

            const modal = document.getElementById('shipmentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = `${shipment.id} - Outbound to ${shipment.destination}`;
            
            const isAlert = shipment.currentTemp > 8;
            const statusColor = shipment.status === 'ALERT' ? '#e53e3e' : shipment.status === 'WARNING' ? '#ed8936' : '#5FA684';
            
            // Generate temperature timeline data
            const timelineData = [
                { time: '08:00', temp: 2.1, status: 'Normal' },
                { time: '10:00', temp: 2.8, status: 'Normal' },
                { time: '12:00', temp: 3.5, status: 'Normal' },
                { time: '14:00', temp: shipment.status === 'ALERT' ? 8.2 : shipment.status === 'WARNING' ? 7.1 : 4.2, status: shipment.status === 'ALERT' ? 'Critical' : shipment.status === 'WARNING' ? 'Warning' : 'Normal' },
                { time: '16:00', temp: shipment.status === 'ALERT' ? 8.8 : shipment.status === 'WARNING' ? 7.4 : 4.8, status: shipment.status === 'ALERT' ? 'Critical' : shipment.status === 'WARNING' ? 'Warning' : 'Normal' },
                { time: 'Now', temp: shipment.currentTemp || 5.2, status: shipment.status === 'ALERT' ? 'Critical' : shipment.status === 'WARNING' ? 'Warning' : 'Normal' }
            ];
            
            modalContent.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <!-- Header Info -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: ${shipment.status === 'ALERT' ? '#fef2f2' : shipment.status === 'WARNING' ? '#fffbeb' : '#E1FCC0'}; border-radius: 8px;">
                        <div><strong>Destination:</strong> ${shipment.destination}</div>
                        <div><strong>Departure:</strong> ${shipment.departure}</div>
                        <div><strong>Medical Device:</strong> ${shipment.medicalDevice}</div>
                        <div><strong>Current Temp:</strong> <span class="${isAlert ? 'temp-alert' : shipment.status === 'WARNING' ? 'temp-warning' : 'temp-normal'}">${shipment.currentTemp}°C</span></div>
                        <div><strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${shipment.status}</span></div>
                        <div><strong>Current Location:</strong> ${shipment.currentLocation}</div>
                        <div><strong>ETA:</strong> ${shipment.eta}</div>
                        <div><strong>Progress:</strong> ${shipment.progress || 'N/A'}</div>
                    </div>
                    
                    <!-- Summary Metrics KPI Cards -->
                    <div>
                        <h3 style="margin-bottom: 15px;">📊 Summary Metrics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(9, 31, 47, 0.1); border-left: 4px solid #5FA684; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2C677B; margin-bottom: 5px;">${shipment.currentTemp || 5.2}°C</div>
                                <div style="font-size: 0.85rem; color: #091F2F;">Current Temp</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(9, 31, 47, 0.1); border-left: 4px solid #ed8936; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2C677B; margin-bottom: 5px;">${Math.max(...timelineData.map(d => d.temp)).toFixed(1)}°C</div>
                                <div style="font-size: 0.85rem; color: #091F2F;">Max Temp</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(9, 31, 47, 0.1); border-left: 4px solid #2C677B; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2C677B; margin-bottom: 5px;">${Math.min(...timelineData.map(d => d.temp)).toFixed(1)}°C</div>
                                <div style="font-size: 0.85rem; color: #091F2F;">Min Temp</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(9, 31, 47, 0.1); border-left: 4px solid #B0FC84; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2C677B; margin-bottom: 5px;">${(timelineData.reduce((sum, d) => sum + d.temp, 0) / timelineData.length).toFixed(1)}°C</div>
                                <div style="font-size: 0.85rem; color: #091F2F;">Avg Temp</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(9, 31, 47, 0.1); border-left: 4px solid #5FA684; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2C677B; margin-bottom: 5px;">${shipment.status === 'ALERT' ? '76' : shipment.status === 'WARNING' ? '92' : '98'}%</div>
                                <div style="font-size: 0.85rem; color: #091F2F;">Time in Range</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Temperature Timeline -->
                    <div>
                        <h3 style="margin-bottom: 15px;">🌡️ Temperature Timeline</h3>
                        <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(9, 31, 47, 0.1);">
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                    <thead>
                                        <tr style="background: #E1FCC0;">
                                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #B0FC84;">Time</th>
                                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #B0FC84;">Temperature</th>
                                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #B0FC84;">Status</th>
                                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #B0FC84;">Location</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${timelineData.map((data, index) => {
                                            const locations = ['Penang Dock', 'Highway Checkpoint', 'Rest Area', 'Border Crossing', 'Destination Approach', shipment.currentLocation || 'In Transit'];
                                            return `
                                            <tr style="${data.status === 'Critical' ? 'background: #fef2f2;' : data.status === 'Warning' ? 'background: #fffbeb;' : ''}">
                                                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">${data.time}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0; font-weight: bold; color: ${data.status === 'Critical' ? '#e53e3e' : data.status === 'Warning' ? '#ed8936' : '#5FA684'};">${data.temp}°C</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
                                                    <span style="padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; background: ${data.status === 'Critical' ? '#fef2f2' : data.status === 'Warning' ? '#fffbeb' : '#f0f8ff'}; color: ${data.status === 'Critical' ? '#e53e3e' : data.status === 'Warning' ? '#ed8936' : '#5FA684'}; border: 1px solid ${data.status === 'Critical' ? '#fed7d7' : data.status === 'Warning' ? '#fbd38d' : '#bee3f8'};">${data.status}</span>
                                                </td>
                                                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.8rem; color: #666;">${locations[index] || 'Unknown'}</td>
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Visual Temperature Chart Area -->
                            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; text-align: center;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-size: 0.8rem; color: #666;">2°C (Safe Min)</span>
                                    <strong style="color: #091F2F;">Temperature Trend</strong>
                                    <span style="font-size: 0.8rem; color: #666;">8°C (Safe Max)</span>
                                </div>
                                <div style="height: 60px; background: linear-gradient(to right, #5FA684 0%, ${shipment.status === 'ALERT' ? '#e53e3e 70%' : shipment.status === 'WARNING' ? '#ed8936 60%, #5FA684 90%' : '#5FA684 100%'}); border-radius: 4px; position: relative; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9rem;">
                                    ${shipment.status === 'ALERT' ? '🚨 CRITICAL EXCURSION DETECTED' : shipment.status === 'WARNING' ? '⚠️ APPROACHING LIMITS' : '✅ WITHIN SAFE RANGE'}
                                </div>
                                <div style="margin-top: 8px; font-size: 0.75rem; color: #666;">Real-time temperature monitoring • Updated every 5 minutes</div>
                            </div>
                        </div>
                    </div>
                    
                    ${locationData ? `
                    <div style="padding: 15px; background: #f0f8ff; border-left: 4px solid #5FA684; border-radius: 8px;">
                        <strong style="color: #5FA684;">📍 DESTINATION INFO:</strong><br>
                        <div style="margin-top: 8px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9rem;">
                            <div><strong>Facility:</strong> ${locationData.name}</div>
                            <div><strong>Status:</strong> ${locationData.status.toUpperCase()}</div>
                            <div><strong>Active Boxes:</strong> ${locationData.count}</div>
                            <div><strong>Avg Temp:</strong> ${locationData.temp}°C</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${shipment.issue ? `
                    <div style="padding: 15px; background: ${shipment.status === 'ALERT' ? '#fef2f2' : '#fffbeb'}; border-left: 4px solid ${statusColor}; border-radius: 8px;">
                        <strong style="color: ${statusColor};">⚠️ ${shipment.status} DETAILS:</strong><br>
                        ${shipment.issue}
                    </div>
                    ` : ''}
                    
                    ${shipment.driver ? `
                    <div>
                        <h3 style="margin-bottom: 15px;">Transport Details</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div><strong>Driver/Handler:</strong> ${shipment.driver}</div>
                            <div><strong>Vehicle:</strong> ${shipment.vehicle}</div>
                            <div><strong>Route:</strong> ${shipment.route}</div>
                            <div><strong>Total Distance:</strong> ${shipment.distance}</div>
                        </div>
                    </div>
                    ` : `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        ${shipment.message}
                    </div>
                    `}
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="contactDriver('${shipment.id}')">📞 Contact Driver</button>
                        <button class="btn btn-secondary" onclick="exportTrackingPDF('${shipment.id}')">📄 Export Report</button>
                        <button class="btn btn-secondary" onclick="viewOnMap('${locationId}')">🗺️ View on Map</button>
                        ${shipment.status === 'ALERT' ? '<button class="btn btn-danger" onclick="escalateAlert(\'' + shipment.id + '\')">🚨 Escalate Alert</button>' : ''}
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Helper function to get location ID by shipment ID
        function getLocationIdByShipmentId(shipmentId) {
            const shipmentToLocationMap = {
                'PG-OUT-001': 'KL-001',
                'PG-OUT-002': 'IP-001',
                'PG-OUT-003': 'MLK-001',
                'PG-OUT-004': 'KT-001',
                'PG-OUT-005': 'KCH-001',
                'PG-OUT-006': 'SDK-001',
                'PG-OUT-007': 'SG-001',
                'PG-OUT-008': 'BKK-001',
                'PG-OUT-009': 'JB-001',
                'PG-OUT-010': 'MRI-001',
                'PG-OUT-011': 'HDY-001',
                'PG-OUT-012': 'KK-001',
                'PG-OUT-013': 'PKT-001'
            };
            return shipmentToLocationMap[shipmentId];
        }

        // View shipment location on map
        function viewOnMap(locationId) {
            showPageDirectly('home');
            // Could add map highlighting functionality here
            showNotification(`🗺️ Switched to map view - look for location ${locationId}`, 'info');
        }

        function contactDriver(shipmentId) {
            alert(`Connecting to driver for shipment ${shipmentId}...\n\nThis would initiate a call or message to the transport driver in a production system.`);
        }

        function exportTrackingPDF(shipmentId) {
            alert(`Generating tracking report for ${shipmentId}...\n\nThis would create a detailed PDF with temperature logs, route information, and compliance data.`);
        }

        function escalateAlert(shipmentId) {
            alert(`🚨 ESCALATING ALERT for ${shipmentId}\n\nNotifying:\n- Penang Dock Manager\n- Cold Chain Supervisor\n- Medical Device Safety Officer\n- Destination facility\n\nEmergency response protocols activated.`);
        }

        // Export functions
        function exportPDF(boxId) {
            alert(`Generating compliance PDF report for medical cold box ${boxId}...`);
        }

        function exportCSV(boxId) {
            alert(`Generating temperature data CSV for cold box ${boxId}...`);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('shipmentModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Medical Cold Chain Dashboard initialized for Malaysia');
            initializeInteractiveMap();
        });

        // Initialize Interactive Map
        function initializeInteractiveMap() {
            // Initialize map centered on Malaysia
            interactiveMap = L.map('interactive-map').setView([4.2105, 101.9758], 6);
            
            // Add tile layers
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });
            
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });
            
            // Add default layer
            streetLayer.addTo(interactiveMap);
            
            // Store layers for switching
            window.mapLayers = { street: streetLayer, satellite: satelliteLayer };
            
            // Add cold chain locations to map
            addColdChainMarkers();
        }

        // Add Cold Chain Markers
        function addColdChainMarkers() {
            coldChainLocations.forEach(location => {
                // Determine marker color based on status
                let markerColor;
                switch(location.status) {
                    case 'active': markerColor = '#5FA684'; break;
                    case 'warning': markerColor = '#ed8936'; break;
                    case 'alert': markerColor = '#e53e3e'; break;
                    default: markerColor = '#2C677B';
                }
                
                // Create custom marker
                const marker = L.circleMarker([location.lat, location.lng], {
                    radius: 8 + (location.count * 2), // Size based on number of cold boxes
                    fillColor: markerColor,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(interactiveMap);
                
                // Create popup content
                const popupContent = `
                    <div style="font-family: 'Segoe UI', sans-serif; min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #091F2F; font-size: 1.1rem;">${location.name}</h3>
                        <div style="display: grid; gap: 5px; font-size: 0.9rem;">
                            <div><strong>Status:</strong> <span style="color: ${markerColor}; text-transform: uppercase; font-weight: bold;">${location.status}</span></div>
                            <div><strong>Cold Boxes:</strong> ${location.count} active</div>
                            <div><strong>Avg Temperature:</strong> ${location.temp}°C</div>
                            <div><strong>Location ID:</strong> ${location.id}</div>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="navigateToLocation(${location.lat}, ${location.lng})" style="padding: 5px 10px; background: #2C677B; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Navigate</button>
                            <button onclick="viewOutboundShipment('${location.id}')" style="padding: 5px 10px; background: #ed8936; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">🚚 Track Shipment</button>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent, {
                    maxWidth: 280,
                    className: 'custom-popup'
                });
                
                // Add hover effect
                marker.on('mouseover', function(e) {
                    this.setStyle({
                        radius: this.options.radius + 2,
                        weight: 3
                    });
                });
                
                marker.on('mouseout', function(e) {
                    this.setStyle({
                        radius: this.options.radius - 2,
                        weight: 2
                    });
                });
            });
        }

        // Map Control Functions
        function refreshMapData() {
            // Simulate data refresh
            const updateTime = document.getElementById('map-last-update');
            updateTime.textContent = new Date().toLocaleTimeString();
            
            // Add some visual feedback
            const refreshBtn = event.target;
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '🔄 Refreshing...';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
                alert('Map data refreshed! All cold chain locations updated.');
            }, 1500);
        }

        function toggleMapView() {
            const toggleBtn = event.target;
            
            if (currentMapView === 'streets') {
                // Switch to satellite
                interactiveMap.removeLayer(window.mapLayers.street);
                interactiveMap.addLayer(window.mapLayers.satellite);
                toggleBtn.innerHTML = '🗺️ Streets';
                currentMapView = 'satellite';
            } else {
                // Switch to streets
                interactiveMap.removeLayer(window.mapLayers.satellite);
                interactiveMap.addLayer(window.mapLayers.street);
                toggleBtn.innerHTML = '🌐 Satellite';
                currentMapView = 'streets';
            }
        }

        function viewLocationDetails(locationId) {
            const location = coldChainLocations.find(loc => loc.id === locationId);
            if (location) {
                alert(`Viewing details for ${location.name}\n\nStatus: ${location.status.toUpperCase()}\nCold Boxes: ${location.count}\nAverage Temperature: ${location.temp}°C\nLocation ID: ${location.id}\n\nThis would open a detailed facility view in a production system.`);
            }
        }

        function navigateToLocation(lat, lng) {
            // Open Google Maps navigation
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(googleMapsUrl, '_blank');
        }

        // Navigate to outbound shipment from map
        function viewOutboundShipment(locationId) {
            // Switch to outbound shipments page
            showPageDirectly('outbound');
            
            // Highlight the corresponding shipment
            setTimeout(() => {
                const targetRow = document.getElementById(`outbound-${locationId}`);
                if (targetRow) {
                    // Remove any existing highlights
                    document.querySelectorAll('#outbound-tbody tr').forEach(row => {
                        row.classList.remove('highlight-row');
                    });
                    
                    // Add highlight to target row
                    targetRow.classList.add('highlight-row');
                    targetRow.style.cssText += `
                        animation: highlightRow 3s ease-in-out;
                        border: 2px solid #5FA684;
                        box-shadow: 0 0 20px rgba(95, 166, 132, 0.3);
                    `;
                    
                    // Scroll to the shipment
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Show notification
                    showNotification(`📍 Showing outbound shipment to ${coldChainLocations.find(loc => loc.id === locationId)?.name}`, 'success');
                    
                    // Remove highlight after animation
                    setTimeout(() => {
                        targetRow.style.animation = '';
                        targetRow.style.border = '';
                        targetRow.style.boxShadow = '';
                        targetRow.classList.remove('highlight-row');
                    }, 3000);
                } else {
                    showNotification(`⚠️ No outbound shipment found for this location`, 'info');
                }
            }, 100);
        }
    </script>
</body>
</html>